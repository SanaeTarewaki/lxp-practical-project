ドローン生産部品在庫管理システム インフラ構築手順書
１．ドキュメント作成者
垂脇さなえ

２．改定履歴
・1.0
作成日時：2024/05/04
更新内容：初版作成

３.はじめに
本ドキュメントは、ドローン生産部品在庫管理システムのインフラ構築手順についての資料となります。

４．目次
<1>ドキュメント作成者
<2>改定履歴
<3>はじめに
<4>目次
<5>作業端末
<6>前提条件
<7>AppRunner構築
<8>ロギングとモニタリングの設定
<9>インフラコスト管理の設定

５．作業端末
Windows11

６．前提条件
・作業用端末にGitHubとDockerを使用したローカルの開発環境が構築済みであること。
　（http://localhost:8080/ をブラウザで立ち上げ、接続可能な状況であること）
・AWSアカウントが作成済みであること。
 
７．App Runner構築
以下の手順でApp Runnerを構築します。

1)自身のAWSコンソールにログインします。
2)サービス「AWS App Runner」を開きます。
3)「サービスの作成」を選択します。
4)ステップ１：ソースおよびデプロイ
　・リポジトリタイプは「ソースコードリポジトリ」を選択します。
　・プロバイダーは「GitHub」を選択します。
　・自身のGitHubを新規追加でリンクさせます。
　・リポジトリを指定します。
　・GitHub連携の「ソースディレクトリ」は「/drone/dev」を指定します。
　・デプロイ設定は「自動」を選択します。

ステップ２：構築を設定
　・設定ファイルは「ここですべての設定を構成する」を選択します。
　・ランタイムは「Corretto 11」を選択します。
　・構築コマンドは「./gradlew bootJar && cp build/libs/dev-0.0.1.jar ./」を指定します。
　・開始コマンドは「java -jar ./dev-0.0.1.jar」を指定します。
　・ポートは「8080」を指定します。

ステップ３：サービスを設定
　・サービス名を設定します。
　
ステップ４：確認および作成
　・設定項目に誤りがないか確認し、「作成とデプロイ」を選択します。

ステータスが「Running」と表示され、デフォルトドメインURL先へ接続ができればデプロイ成功です。

８．ロギングとモニタリングの設定
CloudWatchを使用して、App Runnerの監視を行います。
CloudWatchはAWSクラウドリソースとAWSで実行されるアプリケーションの監視サービスです。

➀ダッシュボードの作成
CloudWatch>ダッシュボート>ダッシュボードの作成
ダッシュボード名を設定したら、ダッシュボードの作成を選択します。

主に以下のウィジェットの追加を行います。
・CPU
・Memory
・Activity

ウィジェットの追加手順
1)CloudWatch>Dashboards>「作成したダッシュボード」を選択します。
2)＋マーク（ウィジェットの追加）を選択します。
3)データ型は「メトリクス」を選択します。
4)ダッシュボードに表示させたい項目を選択します。
5)「ウィジェットの作成」を選択します。
6)ダッシュボードに追加されていることを確認し、保存ボタンで更新します。

②ログでの監視
・CloudWatchロググループを作成

1)CloudWatch>ログ>ロググループを開きます。
2)「ロググループを作成」を選択します。
3)ロググループ名を設定します。
4)「作成」を選択します。

・CloudTrailの証跡を作成
AWSでの利用履歴はCloudTrailを使用してログ出力を行います。　　　　　　　
CloudTrailは、AWSに対するアクティビティログを記録します。記録したログをCloudWatch Logsに送信し、確認することが可能です。

1)CloudTrail>ダッシュボード>「証跡の作成」を開きます。
2)「証跡名」を設定します。
3)ストレージの場所「新しいS3バケットを作成します」を選択します。
4)CloudWatch Logsの有効にチェックを入れます。
5)ロググループは「既存」で、作成したロググループ名を入力します。
6)「IAMロール」は、新規を選択します。
7)「ロール名」を入力します。
8)「次へ」を選択します。
9) 「イベントタイプ」ではログ記録するイベントのタイプを選択します。 
10)「管理イベント」は読み取り・書き込みを選択します。 
11)「次へ」を選択します。 
12)内容を確認して「証跡の作成」を選択します。

９．インフラコスト管理の設定
請求とコスト管理にて作成後、毎月の使用状況と利用料金が表示されます。
1)サービス「請求とコスト管理」を開きます。
2)予算と計画>予算>「予算を作成」を選択します。
3)「テンプレートを使用」を選択します。
4)「月次コスト予算」を選択します。
5)「予算名」を設定します。
6)予算額 $1 を設定します。
7)Eメールの受信者に通知用メールアドレスを入力します。
8)「予算を作成」を選択します。

7で設定した、しきい値を超えたときに通知用メールアドレスにアラートが送信されます。

以上がインフラ構築作業の手順となります。
